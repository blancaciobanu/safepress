rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if the requester is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper: check if the requester owns this document
    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    // Helper: check if the requester is an admin
    function isAdmin() {
      return isAuth() && request.auth.token.email in [
        'ciobanubianca20@stud.ase.ro'
      ];
    }

    // ─── USERS ───────────────────────────────────────────────
    match /users/{userId} {

      // Anyone authenticated can read their own document
      // Admins can read any user document (for verification review)
      // Community posts need to read author info — but that's denormalized
      // into the post itself, so no cross-user reads needed
      allow read: if isOwner(userId) || isAdmin();

      // Users can create their own document on signup
      allow create: if isOwner(userId);

      // Users can update their own document (scores, setup progress)
      // Admins can update any user (verification status)
      allow update: if isOwner(userId) || isAdmin();

      // Users can delete their own document (account deletion)
      allow delete: if isOwner(userId);
    }

    // ─── COMMUNITY POSTS ─────────────────────────────────────
    match /community-posts/{postId} {

      // Anyone can read community posts (public browsing)
      allow read: if true;

      // Authenticated users can create posts
      // Validate that authorId matches the requester
      allow create: if isAuth()
        && request.resource.data.authorId == request.auth.uid
        && request.resource.data.keys().hasAll([
          'type', 'title', 'content', 'authorId', 'authorName',
          'authorIcon', 'authorType', 'category', 'createdAt',
          'likes', 'likedBy', 'comments', 'resolved'
        ]);

      // Authenticated users can update posts (likes, comments, resolved)
      // Only the post author can toggle resolved
      allow update: if isAuth();

      // Only admins can delete posts (moderation)
      allow delete: if isAdmin();
    }

    // ─── SUPPORT REQUESTS ────────────────────────────────────
    match /support-requests/{requestId} {

      // Authenticated users can read all requests
      // (UI restricts specialist view to verified specialists only)
      allow read: if isAuth();

      // Authenticated users can create requests
      allow create: if isAuth();

      // Authenticated users can update (claim, resolve)
      allow update: if isAuth();

      // Only admins can delete requests
      allow delete: if isAdmin();
    }
  }
}
